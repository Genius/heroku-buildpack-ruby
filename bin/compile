#!/usr/bin/env bash
# The actual compilation code lives in `bin/support/ruby_compile`. This file instead
# bootstraps the ruby needed and then executes `bin/support/ruby_compile`

set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BIN_DIR=$(cd "$(dirname "$0")" || exit; pwd)
VENDOR_DIR="$BUILD_DIR/vendor"

echo "-----> Installing build dependencies"
apt-get update && apt-get install -y --no-install-recommends \
  build-essential \
  curl \
  zlib1g-dev

echo "-----> Creating ruby & openssl folders"
openssl_install_dir="$VENDOR_DIR/openssl-1.1.1u"
ruby_install_dir="$VENDOR_DIR/ruby-2.6.9"

mkdir -p "$openssl_install_dir"
mkdir -p "$ruby_install_dir"

echo "-----> Compiling and installing OpenSSL 1.1.1u"
curl -L -o /tmp/openssl-1.1.1u.tar.gz https://www.openssl.org/source/openssl-1.1.1u.tar.gz
tar -xzf /tmp/openssl-1.1.1u.tar.gz -C /tmp

pushd /tmp/openssl-1.1.1u
  ./config --prefix="$openssl_install_dir" shared
  make depend
  make
  make install
popd
rm -rf /tmp/openssl-1.1.1u /tmp/openssl-1.1.1u.tar.gz

echo "-----> Compiling and installing Ruby 2.6.9"
curl -L -o /tmp/ruby-2.6.9.tar.gz https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.9.tar.gz
tar -xzf /tmp/ruby-2.6.9.tar.gz -C /tmp

pushd /tmp/ruby-2.6.9
  ./configure --prefix="$ruby_install_dir" --with-openssl-dir="$openssl_install_dir"
  make
  make install
popd

rm -rf /tmp/ruby-2.6.9 /tmp/ruby-2.6.9.tar.gz

echo "-----> Export ruby bin to the PATH"
export PATH="$ruby_install_dir/bin:$PATH"
unset GEM_PATH

if detect_needs_java "$BUILD_DIR"; then
  cat <<EOM

       ## Warning: Your app needs java

       The Ruby buildpack determined your app needs java installed
       we recommend you add the jvm buildpack to your application:

         $ heroku buildpacks:add heroku/jvm --index=1

-----> Installing Java

EOM

  compile_buildpack_v2 "$BUILD_DIR" "$CACHE_DIR" "$ENV_DIR" "https://buildpack-registry.s3.us-east-1.amazonaws.com/buildpacks/heroku/jvm.tgz" "heroku/jvm"
fi

"$ruby_install_dir"/bin/ruby "$BIN_DIR/support/ruby_compile" "$@"
